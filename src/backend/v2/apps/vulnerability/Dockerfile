FROM node:20

WORKDIR /usr/src/app

COPY package.json pnpm-lock.yaml ./

# Install dependencies
RUN npm install -g pnpm && pnpm install

COPY . .

# Install Nuclei
RUN apt-get update && \
  apt-get install -y wget unzip && \
  wget https://github.com/projectdiscovery/nuclei/releases/download/v3.4.4/nuclei_3.4.4_linux_amd64.zip && \
  unzip -o nuclei_3.4.4_linux_amd64.zip nuclei && \ 
  mv nuclei /usr/local/bin/ && \
  rm nuclei_3.4.4_linux_amd64.zip && \
  rm -rf /var/lib/apt/lists/* && \
  # Install Google Chrome
  wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - && \
  echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
  apt-get update && apt-get install -y google-chrome-stable && apt-get clean && rm -rf /var/lib/apt/lists/*

# Build the specific app using Nx
RUN pnpm nx build vulnerability

# Expose the app's port (adjust as necessary)
EXPOSE 3000

# Start the application
ENV SECRET="EjhtLijYwYRhFzRfGmEYCdpThTVfvvPnbatANPpfxepLHhGKkaJXuyCShNywdLgv"
ENV ALGORITHM="HS256"
ENV LICENSE_SERVER_VALIDATE_URL="https://licence.thefirewall.org"
ENV ACCESS_TOKEN_EXPIRE_MINUTES=1440

# Create startup script
RUN echo '#!/bin/bash\npnpm nx migration:run vulnerability && node dist/apps/vulnerability/main.js' > /usr/src/app/start.sh && \
  chmod +x /usr/src/app/start.sh

CMD ["/usr/src/app/start.sh"]