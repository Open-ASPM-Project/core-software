import { MigrationInterface, QueryRunner } from "typeorm";

export class Migration1742494678085 implements MigrationInterface {
    name = 'Migration1742494678085'

    public async up(queryRunner: QueryRunner): Promise<void> {

        await queryRunner.query(`
            CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
        `);

        await queryRunner.query(`
            CREATE TYPE "public"."vulnerability_v2_scans_status_enum" AS ENUM('pending', 'started', 'completed', 'failed')
        `);

        await queryRunner.query(`
            CREATE TYPE "public"."vulnerabilities_v2_info_severity_enum" AS ENUM('low', 'medium', 'high', 'critical')
        `);

        await queryRunner.query(`
            CREATE TYPE "public"."vulnerability_v2_scans_scan_type_enum" AS ENUM(
                'assetAdded',
                'assetUpdated',
                'scheduledScan',
                'manualScan',
                'liveScanNucleiTemplateChange'
            )
        `);
        await queryRunner.query(`
            CREATE TABLE "vulnerability_v2_scans" (
                "id" SERIAL NOT NULL,
                "uuid" uuid NOT NULL DEFAULT uuid_generate_v4(),
                "status" "public"."vulnerability_v2_scans_status_enum" NOT NULL DEFAULT 'pending',
                "scan_type" "public"."vulnerability_v2_scans_scan_type_enum" NOT NULL DEFAULT 'assetAdded',
                "scheduler_scan_id" integer,
                "user_id" integer,
                "asset_id" character varying,
                "created_at" TIMESTAMP NOT NULL DEFAULT now(),
                "updated_at" TIMESTAMP NOT NULL DEFAULT now(),
                CONSTRAINT "UQ_f75afda1be66b03da950dffc9c9" UNIQUE ("uuid"),
                CONSTRAINT "PK_1a418c5b4c102bce809abff8d1d" PRIMARY KEY ("id")
            )
        `);
        await queryRunner.query(`
            CREATE TABLE "vulnerabilities_v2" (
                "id" SERIAL NOT NULL,
                "uuid" uuid NOT NULL DEFAULT uuid_generate_v4(),
                "template_id" character varying NOT NULL,
                "template_path" text,
                "template_encoded" text,
                "info_name" character varying,
                "info_severity" "public"."vulnerabilities_v2_info_severity_enum",
                "info_description" text,
                "info_impact" text,
                "info_remediation" text,
                "type" character varying,
                "host" character varying,
                "port" character varying,
                "scheme" character varying,
                "url" character varying,
                "matched_at" character varying,
                "request" text,
                "response" text,
                "ip" character varying,
                "timestamp" TIMESTAMP WITH TIME ZONE,
                "curl_command" text,
                "matcher_status" boolean,
                "all_payload" jsonb,
                "profile" character varying NOT NULL,
                "created_at" TIMESTAMP NOT NULL DEFAULT now(),
                "updated_at" TIMESTAMP NOT NULL DEFAULT now(),
                "configuration_id" integer,
                "asset_id" character varying NOT NULL,
                "asset_name" character varying NOT NULL,
                "asset_type" character varying NOT NULL,
                "scan_id" integer,
                CONSTRAINT "UQ_d0886ea275306f0aab110548723" UNIQUE ("uuid"),
                CONSTRAINT "PK_3d790eea5c39a06abbc9204b80d" PRIMARY KEY ("id")
            )
        `);
        await queryRunner.query(`
            CREATE TABLE "configurations" (
                "id" SERIAL NOT NULL,
                "uuid" uuid NOT NULL DEFAULT uuid_generate_v4(),
                "name" character varying NOT NULL DEFAULT 'default',
                "config" jsonb NOT NULL,
                "createdAt" TIMESTAMP NOT NULL DEFAULT now(),
                "updatedAt" TIMESTAMP NOT NULL DEFAULT now(),
                CONSTRAINT "UQ_04bcb6cb81b7201dcad614ceef0" UNIQUE ("uuid"),
                CONSTRAINT "UQ_d8473217e1bad80a1746b987ca6" UNIQUE ("name"),
                CONSTRAINT "PK_ef9fc29709cc5fc66610fc6a664" PRIMARY KEY ("id")
            )
        `);
        await queryRunner.query(`
            ALTER TABLE "vulnerabilities_v2"
            ADD CONSTRAINT "FK_92eec34d3660d764f0bcc4f1f60" FOREIGN KEY ("configuration_id") REFERENCES "configurations"("id") ON DELETE
            SET NULL ON UPDATE NO ACTION
        `);
        await queryRunner.query(`
            ALTER TABLE "vulnerabilities_v2"
            ADD CONSTRAINT "FK_8803e662f4fe0ed00b24a936fe5" FOREIGN KEY ("scan_id") REFERENCES "vulnerability_v2_scans"("id") ON DELETE CASCADE ON UPDATE NO ACTION
        `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`
            ALTER TABLE "vulnerabilities_v2" DROP CONSTRAINT "FK_8803e662f4fe0ed00b24a936fe5"
        `);
        await queryRunner.query(`
            ALTER TABLE "vulnerabilities_v2" DROP CONSTRAINT "FK_92eec34d3660d764f0bcc4f1f60"
        `);
        await queryRunner.query(`
            DROP TABLE "configurations"
        `);
        await queryRunner.query(`
            DROP TABLE "vulnerabilities_v2"
        `);
        await queryRunner.query(`
            DROP TABLE "vulnerability_v2_scans"
        `);
        await queryRunner.query(`
            DROP TYPE "public"."vulnerability_v2_scans_scan_type_enum"
        `);
        await queryRunner.query(`
            DROP TYPE "public"."vulnerability_v2_scans_status_enum"
        `);
    }

}
