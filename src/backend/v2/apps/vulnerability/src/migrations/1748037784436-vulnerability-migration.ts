import { MigrationInterface, QueryRunner, TableColumn } from 'typeorm';

export class VulnerabilityMigration1748037784436 implements MigrationInterface {
  public async up(queryRunner: QueryRunner): Promise<void> {
    // Updating vulnerability_profiles_enum to include 'file'
    await queryRunner.query(`
      CREATE TYPE "vulnerability_profiles_enum_new" AS ENUM(
        'cve',
        'default-logins',
        'dns',
        'misconfig',
        'ssl',
        'owasp-top-10',
        'tech-detect',
        'dast',
        'file'
      );
    `);

    await queryRunner.query(`
      ALTER TABLE "schedule"
      ALTER COLUMN "vulnerability_profiles" DROP DEFAULT;
    `);

    await queryRunner.query(`
      ALTER TABLE "asset_allowlist"
      ALTER COLUMN "vulnerability_profiles" DROP DEFAULT;
    `);

    await queryRunner.query(`
      ALTER TABLE "vulnerabilities_v2"
      ALTER COLUMN "profile"
      TYPE "vulnerability_profiles_enum_new"
      USING "profile"::text::"vulnerability_profiles_enum_new";
    `);

    await queryRunner.query(`
      ALTER TABLE "schedule"
      ALTER COLUMN "vulnerability_profiles"
      TYPE "vulnerability_profiles_enum_new"[]
      USING "vulnerability_profiles"::text[]::"vulnerability_profiles_enum_new"[];
    `);

    await queryRunner.query(`
      ALTER TABLE "asset_allowlist"
      ALTER COLUMN "vulnerability_profiles"
      TYPE "vulnerability_profiles_enum_new"[]
      USING "vulnerability_profiles"::text[]::"vulnerability_profiles_enum_new"[];
    `);

    await queryRunner.query(`
      DROP TYPE "vulnerability_profiles_enum";
    `);

    await queryRunner.query(`
      ALTER TYPE "vulnerability_profiles_enum_new"
      RENAME TO "vulnerability_profiles_enum";
    `);

    await queryRunner.query(`
      ALTER TABLE "schedule"
      ALTER COLUMN "vulnerability_profiles"
      SET DEFAULT ARRAY[]::vulnerability_profiles_enum[];
    `);

    await queryRunner.query(`
      ALTER TABLE "asset_allowlist"
      ALTER COLUMN "vulnerability_profiles"
      SET DEFAULT ARRAY[]::vulnerability_profiles_enum[];
    `);

    // Drop the `asset_type` column
    await queryRunner.dropColumn('vulnerabilities_v2', 'asset_type');

    // Add the `asset_type` column with the new type and nullable property
    await queryRunner.addColumn(
      'vulnerabilities_v2',
      new TableColumn({
        name: 'asset_type',
        type: 'enum',
        enumName: 'asset_type_enum',
        isNullable: true,
      })
    );

    // Drop the `asset_name` column
    await queryRunner.dropColumn('vulnerabilities_v2', 'asset_name');

    // Add the `asset_name` column with the nullable property
    await queryRunner.addColumn(
      'vulnerabilities_v2',
      new TableColumn({
        name: 'asset_name',
        type: 'varchar',
        isNullable: true,
      })
    );
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    // Drop the `asset_type` column
    await queryRunner.query(`
      ALTER TABLE "vulnerabilities_v2" DROP COLUMN "asset_type";
    `);

    // Add the `asset_type` column with the original type and non-nullable property
    await queryRunner.query(`
      ALTER TABLE "vulnerabilities_v2" ADD COLUMN "asset_type" VARCHAR NOT NULL;
    `);

    // Drop the `asset_name` column
    await queryRunner.query(`
      ALTER TABLE "vulnerabilities_v2" DROP COLUMN "asset_name";
    `);

    // Add the `asset_name` column with the non-nullable property
    await queryRunner.query(`
      ALTER TABLE "vulnerabilities_v2" ADD COLUMN "asset_name" VARCHAR NOT NULL;
    `);
  }
}
