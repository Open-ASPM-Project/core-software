from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime
from enum import Enum

class VulnerabilityType(str, Enum):
    CVE = "cve"
    DEPENDENCY_CONFUSION = "dependency-confusion"


class VulnerabilityBase(BaseModel):
    vulnerability_id: str
    vulnerability_data_source: Optional[str]
    vulnerability_urls: Optional[List[str]]
    cve_id: Optional[str]
    cve_urls: Optional[List[str]]
    cve_data_source: Optional[str]
    severity: Optional[str]
    description: Optional[str]
    cvss_base_score: Optional[float]
    cvss_exploitability_score: Optional[float]
    cvss_impact_score: Optional[float]
    fix_available: bool
    package: Optional[str]
    package_version: Optional[str]
    artifact_type: Optional[str]
    artifact_path: Optional[str]
    whitelist_id: Optional[int] = 0
    whitelisted: Optional[bool] = False
    vulnerability_type: VulnerabilityType
    license: Optional[str]


class VulnerabilityResponse(VulnerabilityBase):
    id: int
    repository_id: int
    repository_scan_id: int
    vc_id: int
    created_at: Optional[datetime]

    class Config:
        from_attributes = True


class VulnerabilityGroupedResponse(BaseModel):
    repository_id: int
    repository_name: str
    vulnerabilities: List[VulnerabilityResponse]


class VulnerabilityPaginationResponse(BaseModel):
    data: List[VulnerabilityResponse]
    total: int
    page: int
    size: int


class FilterValuesResponse(BaseModel):
    values: List[str]
    total: int

class UniqueVulnerabilityFetchParams(BaseModel):
    search: Optional[str] = None
    repo_ids: Optional[List[int]] = None
    vc_ids: Optional[List[int]] = None
    pr_ids: Optional[List[int]] = None
    live_commit_ids: Optional[List[int]] = None

    # Multi-select filters (plural)
    vulnerability_ids: Optional[List[str]] = None
    cve_ids: Optional[List[str]] = None
    severities: Optional[List[str]] = None

    created_after: Optional[datetime] = None
    created_before: Optional[datetime] = None

    packages: Optional[List[str]] = None
    package_versions: Optional[List[str]] = None
    artifact_types: Optional[List[str]] = None
    artifact_paths: Optional[List[str]] = None

    licenses: Optional[List[str]] = None
    vulnerability_types: Optional[List[VulnerabilityType]] = None

    vulnerability_data_source: Optional[str] = None
    vulnerability_urls: Optional[List[str]] = None
    cve_urls: Optional[List[str]] = None
    cve_data_source: Optional[str] = None
    description: Optional[str] = None
    cvss_base_score: Optional[float] = None
    cvss_exploitability_score: Optional[float] = None
    cvss_impact_score: Optional[float] = None
    fix_available: Optional[bool] = None

    limit: int = 10
    page: int = 1
    sort_by: str = "created_at"
    order_by: str = "asc"
